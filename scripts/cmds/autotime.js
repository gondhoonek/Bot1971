const moment = require("moment-timezone");

module.exports.config = {
  name: "autohadis4hour",
  version: "1.0",
  role: 0,
  author: "Mohammad Akash | ChatGPT Edition",
  description: "â° à¦ªà§à¦°à¦¤à¦¿ à§ª à¦˜à¦£à§à¦Ÿà¦¾ à¦ªà¦°à¦ªà¦° à¦¸à¦®à§Ÿà¦¸à¦¹ à¦¦à¦¾à¦¨à¦•à¦¾à¦°à§€à¦° à¦«à¦œà¦¿à¦²à¦¤à§‡à¦° à¦¹à¦¾à¦¦à¦¿à¦¸ à¦ªà¦¾à¦ à¦¾à¦¬à§‡",
  category: "AutoTime",
  countDown: 3
};

let lastSentSlot = null;
let dailyIndex = 0;
let lastDate = null;

module.exports.onLoad = async function ({ api }) {

  setTimeout(() => {

    // ðŸ•Œ à¦¦à¦¾à¦¨à¦•à¦¾à¦°à§€à¦° à¦«à¦œà¦¿à¦²à¦¤ à¦¸à¦®à§à¦ªà¦°à§à¦•à¦¿à¦¤ à¦…à¦¨à§‡à¦•à¦—à§à¦²à§‹ à¦¹à¦¾à¦¦à¦¿à¦¸
    const hadithList = [
      "à¦¦à¦¾à¦¨ à¦•à¦°à¦²à§‡ à¦¸à¦®à§à¦ªà¦¦ à¦•à¦®à§‡ à¦¨à¦¾ à¦¬à¦°à¦‚ à¦†à¦²à§à¦²à¦¾à¦¹ à¦¤à¦¾ à¦¬à¦¹à§à¦—à§à¦£ à¦¬à¦¾à§œà¦¿à§Ÿà§‡ à¦¦à§‡à¦¨à¥¤ (à¦¸à¦¹à¦¿à¦¹ à¦®à§à¦¸à¦²à¦¿à¦®)",
      "à¦†à¦²à§à¦²à¦¾à¦¹à¦° à¦ªà¦¥à§‡ à¦¬à§à¦¯à§Ÿ à¦•à¦°à¦¾ à¦‰à¦¤à§à¦¤à¦® à¦¸à¦®à§à¦ªà¦¦à¥¤ (à¦¸à¦¹à¦¿à¦¹ à¦¬à§à¦–à¦¾à¦°à¦¿)",
      "à¦¸à¦¦à¦•à¦¾ à¦†à¦²à§à¦²à¦¾à¦¹à¦° à¦—à¦œà¦¬ à¦¨à¦¿à¦¬à¦¾à¦°à¦£ à¦•à¦°à§‡à¥¤ (à¦¤à¦¿à¦°à¦®à¦¿à¦œà¦¿)",
      "à¦¦à¦¾à¦¨ à¦•à¦¿à§Ÿà¦¾à¦®à¦¤à§‡à¦° à¦¦à¦¿à¦¨ à¦›à¦¾à§Ÿà¦¾ à¦¹à§Ÿà§‡ à¦¯à¦¾à¦¬à§‡à¥¤ (à¦¨à¦¾à¦¸à¦¾à§Ÿà¦¿)",
      "à¦à¦•à¦Ÿà¦¿ à¦–à§‡à¦œà§à¦° à¦ªà¦°à¦¿à¦®à¦¾à¦£ à¦¦à¦¾à¦¨à¦“ à¦œà¦¾à¦¹à¦¾à¦¨à§à¦¨à¦¾à¦® à¦¥à§‡à¦•à§‡ à¦°à¦•à§à¦·à¦¾ à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à§‡à¥¤ (à¦¬à§à¦–à¦¾à¦°à¦¿)",
      "à¦—à§‹à¦ªà¦¨à§‡ à¦¦à¦¾à¦¨ à¦•à¦°à¦¾ à¦†à¦²à§à¦²à¦¾à¦¹à¦° à¦•à¦¾à¦›à§‡ à¦¸à¦¬à¦šà§‡à§Ÿà§‡ à¦ªà§à¦°à¦¿à§Ÿà¥¤ (à¦¤à¦¿à¦°à¦®à¦¿à¦œà¦¿)",
      "à¦¦à¦¾à¦¨ à¦•à¦°à¦²à§‡ à¦¬à¦¿à¦ªà¦¦ à¦¦à§‚à¦° à¦¹à§Ÿà¥¤ (à¦¤à¦¾à¦¬à¦°à¦¾à¦¨à¦¿)",
      "à¦¸à¦¦à¦•à¦¾ à¦®à¦¾à¦¨à§à¦·à§‡à¦° à¦°à¦¿à¦œà¦¿à¦• à¦¬à¦¾à§œà¦¿à§Ÿà§‡ à¦¦à§‡à§Ÿà¥¤ (à¦¬à¦¾à§Ÿà¦¹à¦¾à¦•à¦¿)",
      "à¦¦à¦¾à¦¨ à¦•à¦°à¦²à§‡ à¦¸à¦®à§à¦ªà¦¦ à¦ªà¦¬à¦¿à¦¤à§à¦° à¦¹à§Ÿà¥¤ (à¦®à§à¦¸à¦²à¦¿à¦®)",
      "à¦¦à¦¾à¦¨à¦•à¦¾à¦°à§€à¦° à¦œà¦¨à§à¦¯ à¦«à§‡à¦°à§‡à¦¶à¦¤à¦¾à¦°à¦¾ à¦¦à§‹à§Ÿà¦¾ à¦•à¦°à§‡à¦¨à¥¤ (à¦¬à§à¦–à¦¾à¦°à¦¿)",
      "à¦¸à¦¦à¦•à¦¾ à¦—à§à¦¨à¦¾à¦¹ à¦®à§‹à¦šà¦¨ à¦•à¦°à§‡à¥¤ (à¦¤à¦¿à¦°à¦®à¦¿à¦œà¦¿)",
      "à¦¦à¦¾à¦¨ à¦œà¦¾à¦¨à§à¦¨à¦¾à¦¤à§‡ à¦ªà§à¦°à¦¬à§‡à¦¶à§‡à¦° à¦¸à¦¹à¦œ à¦ªà¦¥à¥¤ (à¦¤à¦¾à¦¬à¦°à¦¾à¦¨à¦¿)",
      "à¦¸à¦¦à¦•à¦¾ à¦•à¦¬à¦°à§‡à¦° à¦†à¦¯à¦¾à¦¬ à¦¥à§‡à¦•à§‡ à¦°à¦•à§à¦·à¦¾ à¦•à¦°à§‡à¥¤ (à¦¬à¦¾à§Ÿà¦¹à¦¾à¦•à¦¿)",
      "à¦¦à¦¾à¦¨ à¦®à¦¾à¦¨à§à¦·à§‡à¦° à¦¹à§ƒà¦¦à§Ÿà¦•à§‡ à¦¨à¦°à¦® à¦•à¦°à§‡à¥¤ (à¦¬à¦¾à§Ÿà¦¹à¦¾à¦•à¦¿)",
      "à¦¦à¦¾à¦¨ à¦•à¦°à¦²à§‡ à¦†à¦²à§à¦²à¦¾à¦¹ à¦¸à¦¨à§à¦¤à§à¦·à§à¦Ÿ à¦¹à¦¨à¥¤ (à¦®à¦°à§à¦®à¦¾à¦°à§à¦¥)",
      "à¦¸à¦¦à¦•à¦¾ à¦¦à§à¦¨à¦¿à§Ÿà¦¾ à¦“ à¦†à¦–à¦¿à¦°à¦¾à¦¤à§‡ à¦¸à¦®à§à¦®à¦¾à¦¨ à¦¬à¦¾à§œà¦¾à§Ÿà¥¤ (à¦¨à¦¾à¦¸à¦¾à§Ÿà¦¿)",
      "à¦¦à¦¾à¦¨ à¦•à¦°à¦²à§‡ à¦†à¦²à§à¦²à¦¾à¦¹à¦° à¦°à¦¹à¦®à¦¤ à¦¨à§‡à¦®à§‡ à¦†à¦¸à§‡à¥¤ (à¦†à¦¹à¦®à¦¦)",
      "à¦¸à¦¦à¦•à¦¾ à¦¬à¦¿à¦ªà¦¦-à¦†à¦ªà¦¦ à¦¥à§‡à¦•à§‡ à¦¢à¦¾à¦² à¦¹à§Ÿà¥¤ (à¦¤à¦¿à¦°à¦®à¦¿à¦œà¦¿)",
      "à¦¦à¦¾à¦¨ à¦®à¦¾à¦¨à§à¦·à¦•à§‡ à¦†à¦²à§à¦²à¦¾à¦¹à¦° à¦¨à§ˆà¦•à¦Ÿà§à¦¯ à¦¦à¦¾à¦¨ à¦•à¦°à§‡à¥¤ (à¦†à¦¹à¦®à¦¦)",
      "à¦¸à¦¦à¦•à¦¾ à¦­à¦¾à¦—à§à¦¯ à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨à§‡à¦° à¦•à¦¾à¦°à¦£ à¦¹à§Ÿà¥¤ (à¦¤à¦¾à¦¬à¦°à¦¾à¦¨à¦¿)",
      "à¦¦à¦¾à¦¨ à¦•à¦°à¦²à§‡ à¦¦à§à¦ƒà¦–-à¦•à¦·à§à¦Ÿ à¦¦à§‚à¦° à¦¹à§Ÿà¥¤ (à¦®à¦°à§à¦®à¦¾à¦°à§à¦¥)",
      "à¦¸à¦¦à¦•à¦¾ à¦œà¦¾à¦¨à§à¦¨à¦¾à¦¤à§‡à¦° à¦¦à¦°à¦œà¦¾ à¦–à§à¦²à§‡ à¦¦à§‡à§Ÿà¥¤ (à¦¨à¦¾à¦¸à¦¾à§Ÿà¦¿)",
      "à¦¦à¦¾à¦¨ à¦•à¦°à¦²à§‡ à¦†à¦²à§à¦²à¦¾à¦¹ à¦¤à¦¾à¦° à¦¬à¦¦à¦²à¦¾ à¦¦à§‡à¦¨à¥¤ (à¦•à§à¦°à¦†à¦¨à§‡à¦° à¦®à¦°à§à¦®à¦¾à¦°à§à¦¥)",
      "à¦¸à¦¦à¦•à¦¾ à¦®à¦¾à¦¨à§à¦·à¦•à§‡ à¦†à¦²à§à¦²à¦¾à¦¹à¦° à¦¬à¦¨à§à¦§à§à¦¦à§‡à¦° à¦…à¦¨à§à¦¤à¦°à§à¦­à§à¦•à§à¦¤ à¦•à¦°à§‡à¥¤ (à¦†à¦¹à¦®à¦¦)"
    ];

    const sendHadisEvery4Hour = async () => {
      const now = moment().tz("Asia/Dhaka");
      const hour = parseInt(now.format("HH"));

      // â° à§ª à¦˜à¦£à§à¦Ÿà¦¾ à¦¸à§à¦²à¦Ÿ (0,4,8,12,16,20)
      if (hour % 4 !== 0) return;

      const slotKey = now.format("YYYY-MM-DD HH");
      const today = now.format("YYYY-MM-DD");

      // ðŸ” à¦¨à¦¤à§à¦¨ à¦¦à¦¿à¦¨ à¦¶à§à¦°à§ à¦¹à¦²à§‡ à¦¹à¦¾à¦¦à¦¿à¦¸ à¦°à¦¿à¦¸à§‡à¦Ÿ
      if (lastDate !== today) {
        dailyIndex = 0;
        lastDate = today;
      }

      if (lastSentSlot === slotKey) return;
      lastSentSlot = slotKey;

      const timeFormatted = now.format("hh:mm A");
      const dateFormatted = now.format("DD MMMM YYYY, dddd");

      const hadis = hadithList[dailyIndex % hadithList.length];
      dailyIndex++;

      const finalMessage = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    ðŸ•Œ ðˆð’ð‹ð€ðŒðˆð‚ ð‘ð„ðŒðˆððƒð„ð‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ•’ à¦¸à¦®à§Ÿ : ${timeFormatted}  
ðŸ“… à¦¤à¦¾à¦°à¦¿à¦– : ${dateFormatted}

âœ¨â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœ¨
   ðŸ¤² à¦¦à¦¾à¦¨à¦•à¦¾à¦°à§€à¦° à¦«à¦œà¦¿à¦²à¦¤
âœ¨â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœ¨

â€œ${hadis}â€

 âœ¨â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœ¨
  à¦¨à¦¾à¦®à¦ƒ      
 à¦¤à¦¸à¦¬à¦¿ à¦ªà¦¯à¦¼à§‡à¦¨à§à¦Ÿà¦ƒ
 âœ¨â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœ¨

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ðŸŒ¸à¦†à¦¤-à¦¤à¦¾à¦•à§à¦¬à¦“à§Ÿà¦¾ à¦«à¦¾à¦‰à¦¨à§à¦¡à§‡à¦¶à¦¨ðŸŒ¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;

      try {
        let threads = [];
        let cursor = null;

        do {
          const data = await api.getThreadList(100, cursor, ["INBOX"]);
          threads.push(...data);
          cursor = data[data.length - 1]?.threadID;
        } while (cursor);

        const groups = threads.filter(t => t.isGroup);

        for (const g of groups) {
          await api.sendMessage(finalMessage, g.threadID);
        }

        console.log(`âœ… à¦ªà§à¦°à¦¤à¦¿ à§ª à¦˜à¦£à§à¦Ÿà¦¾ à¦ªà¦°à¦ªà¦° à¦¹à¦¾à¦¦à¦¿à¦¸ à¦ªà¦¾à¦ à¦¾à¦¨à§‹ à¦¹à§Ÿà§‡à¦›à§‡ â†’ ${groups.length} à¦—à§à¦°à§à¦ª`);
      } catch (err) {
        console.error("âŒ Auto Hadis Error:", err);
      }
    };

    // â±ï¸ à¦ªà§à¦°à¦¤à¦¿ à§§ à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡ à¦šà§‡à¦•
    setInterval(sendHadisEvery4Hour, 60 * 1000);
    console.log("âœ… Auto Hadis (4 Hour) System Running...");
  }, 5000);
};

module.exports.onStart = () => {};
